<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
        th:replace="~{layout :: layout(~{::content})}">
<div th:fragment="content" class="p-4 sm:p-6 max-w-5xl mx-auto">

    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center sm:text-left" th:text="${title}">Todo一覧</h1>

    <!-- 検索フォーム -->
    <form th:action="@{/todos}" method="get"
        class="flex flex-col sm:flex-row sm:items-center gap-3 mb-6">
    <input type="text" name="keyword" placeholder="タイトルで検索"
            th:value="${keyword != null ? keyword : ''}"
            class="border border-gray-300 rounded-lg px-3 py-2 w-full sm:w-72 focus:ring focus:ring-blue-200">
    <div class="flex gap-2">
        <button type="submit"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition w-full sm:w-auto">検索</button>
        <a th:href="@{/todos}" class="text-gray-600 hover:underline text-center sm:text-left w-full sm:w-auto">リセット</a>
    </div>
    </form>

    <!-- 新規作成ボタン -->
    <a th:href="@{/todos/new}"
        class="inline-block mb-6 bg-green-500 text-white px-5 py-2 rounded-lg hover:bg-green-600 transition w-full sm:w-auto text-center">新規Todo作成</a>

    <!-- 並び替え -->
    <div class="mb-4 text-sm sm:text-base text-center sm:text-left">
        <span class="font-semibold">並び替え：</span>
        <a th:href="@{/todos(sort='title_asc', keyword=${keyword})}" class="text-blue-600 hover:underline">タイトル昇順</a>
        <a th:href="@{/todos(sort='title_desc', keyword=${keyword})}" class="text-blue-600 hover:underline">タイトル降順</a>
        <a th:href="@{/todos(sort='dueDate_asc', keyword=${keyword})}" class="text-blue-600 hover:underline">期限が近い順</a>
        <a th:href="@{/todos(sort='dueDate_desc', keyword=${keyword})}" class="text-blue-600 hover:underline">期限が遠い順</a>
    </div>

    <!-- 一覧テーブル（横スクロール対応） -->
    <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 text-left text-sm sm:text-base">
            <thead class="bg-gray-100">
            <tr>
                <th class="px-3 py-2 border">ID</th>
                <th class="px-3 py-2 border">タイトル</th>
                <th class="px-3 py-2 border">カテゴリ</th>
                <th class="px-3 py-2 border">期限</th>
                <th class="px-3 py-2 border">残り日数</th>
                <th class="px-3 py-2 border">操作</th>
                <th class="px-3 py-2 border text-center">完了</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="todo : ${todoPage.content}"
                th:classappend="${todo.completed} ? 'bg-gray-200 line-through text-gray-500' :
                        (${todo.dueDate != null && todo.dueDate.isBefore(today)} ? 'bg-yellow-100' :
                        (${todo.dueDate != null && todo.dueDate.isEqual(today)} ? 'bg-red-100' :
                        (${todo.dueDate != null && todo.dueDate.isBefore(today.plusDays(2))} ? 'bg-green-100' : 'bg-white')))"
                class="hover:bg-gray-50 transition">
                <td class="px-3 py-2 border" th:text="${todo.id}"></td>
                <td class="px-3 py-2 border" th:text="${todo.title}"></td>
                <td class="px-3 py-2 border" th:text="${todo.category != null ? todo.category.name : '未分類'}"></td>
                <td class="px-3 py-2 border" th:text="${todo.dueDate != null ? todo.dueDate : '未設定'}"></td>
                <td class="px-3 py-2 border"
                    th:text="${todo.deadlineStatus}"
                    th:classappend="${todo.deadlineStatus == '1日前' || todo.deadlineStatus == '期限切れ' || todo.deadlineStatus == '本日期限'} ? 'text-red-600 font-semibold' : ''">
                </td>
                <td class="px-3 py-2 border whitespace-nowrap">
                <a th:href="@{'/todos/' + ${todo.id}}" class="text-blue-500 hover:underline">詳細</a> |
                <a th:href="@{'/todos/edit/' + ${todo.id}}" class="text-green-500 hover:underline">編集</a> |
                <a th:href="@{'/todos/delete/' + ${todo.id}}" class="text-red-500 hover:underline"
                    onclick="return confirm('本当に削除しますか？');">削除</a>
                </td>
                <td class="px-3 py-2 border text-center">
                    <form th:action="@{'/todos/' + ${todo.id} + '/toggle'}" method="post">
                    <input type="hidden" name="page" th:value="${todoPage.number}">
                    <input type="hidden" name="keyword" th:value="${keyword}">
                    <input type="hidden" name="sort" th:value="${sort}">
                    <input type="checkbox" name="completed"
                            th:checked="${todo.completed}"
                            onchange="this.form.submit()"
                            class="w-5 h-5 accent-green-500">
            </form>
            </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ページネーション -->
    <div class="flex justify-center mt-6 gap-3 text-sm sm:text-base">
        <a th:if="${!todoPage.first}"
            th:href="@{|/todos?page=${todoPage.number - 1}&keyword=${keyword}&sort=${sort}|}"
            class="px-3 py-1 border rounded hover:bg-gray-100">前へ</a>

        <span th:text="${todoPage.number + 1} + ' / ' + ${todoPage.totalPages}"></span>

        <a th:if="${!todoPage.last}"
        th:href="@{|/todos?page=${todoPage.number + 1}&keyword=${keyword}&sort=${sort}|}"
        class="px-3 py-1 border rounded hover:bg-gray-100">次へ</a>
    </div>
</div>
</html>
